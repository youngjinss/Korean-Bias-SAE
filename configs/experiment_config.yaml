# Experiment Configuration for Korean Bias SAE Project

# Model Configuration
model:
  name: "LGAI-EXAONE/EXAONE-3.0-7.8B-Instruct"
  devices: ["cuda:2", "cuda:3"]  # List of devices; single element = single-GPU, multiple = DataParallel
  dtype: "float16"  # or "float32" for better precision

# SAE Configuration
sae:
  # Path to pre-trained SAE weights
  # Options:
  #   1. Train your own SAE (see scripts/train_sae.py - TO BE IMPLEMENTED)
  #   2. Use pre-trained SAE from external source
  #   3. Set to null to train from scratch
  path: null  # Set to SAE weights path when available, e.g., "checkpoints/sae_model.pth"
  feature_dim: 100000
  activation_dim: 4096
  target_layer: 15  # Which layer to extract from (check SAE training config)
  token_position: "last"  # last, mean, or specific
  sae_type: "gated"  # gated or standard

  # SAE Training Configuration
  training:
    total_steps: 10000  # Total training steps (pilot: 10k, medium: 50k, full: 100k)
    batch_size: 32
    learning_rate: 1e-4
    sparsity_penalty: 0.1  # L1 penalty coefficient
    p_start: 1.0  # Starting p for Lp^p sparsity (1.0 = L1)
    p_end: 0.0  # Ending p for Lp^p sparsity (0.0 = L0 approximation)
    anneal_start: 5000  # When to start annealing p
    warmup_steps: 1000  # Learning rate warmup steps
    save_interval: 1000  # Save checkpoint every N steps
    log_interval: 100  # Log metrics every N steps

# Linear Probe Configuration
probe:
  input_dim: 100000  # SAE feature dimension
  output_dim: 10  # Fixed to max demographic values (인종 has 10)
                  # Uses masking for demographics with fewer values
                  # 성별=2, 나이=4, 종교=6, 외모=8, 직업=8, 인종=10
  hidden_dims: []  # Empty = simple linear layer; can add [512, 256] for MLP
  learning_rate: 1e-3
  batch_size: 32
  epochs: 50
  early_stopping_patience: 5
  weight_decay: 1e-5  # L2 regularization
  loss_type: "kl"  # kl (KL divergence) or ce (cross-entropy)

# IG² Configuration
ig2:
  num_steps: 20  # Number of integration steps
  use_squared_gap: false  # Use (logit1 - logit2)^2 instead of |logit1 - logit2|
  threshold_ratio: 0.2  # 20% of max score to identify bias features
  batch_size: 16  # For batched IG² computation

# Data Configuration
data:
  # Pilot configuration (Week 1)
  pilot:
    num_modifiers:
      negative: 5  # Start very small
      positive: 5
    num_templates: 3
    modifier_types: ["N", "P"]  # Only basic negative and positive

  # Medium configuration (Week 2)
  medium:
    num_modifiers:
      negative: 50
      positive: 50
    num_templates: 5
    modifier_types: ["N", "P"]

  # Full configuration (Week 3+)
  full:
    num_modifiers:
      negative: 300  # N, Ner, Nest
      positive: 300  # P, Per, Pest
    num_templates: 17
    modifier_types: ["N", "Ner", "Nest", "P", "Per", "Pest"]

  # Demographic configuration
  # Available demographics: 성별, 인종, 종교, 성적지향, 나이, 외모, 경제수준, 정치성향, 직업
  # See data/demographic_dict_ko.json for all options
  demographic: "성별"  # Default: gender
  demographic_values: [" 남자", " 여자"]  # Leading space is important for tokenization!

  # To use other demographics, update both fields above. Examples:
  # demographic: "인종"
  # demographic_values: [" 흑인", " 백인", " 아시아인"]
  #
  # demographic: "나이"
  # demographic_values: [" 젊은", " 늙은"]

  # QA Format Configuration
  # When enabled, prompts use numbered multiple choice options (0-indexed)
  # Example: "게으른 사람의 성별은?\n0. 남자\n1. 여자\n답:"
  # Model answers with a number (0, 1, 2...) instead of the demographic value
  qa_format:
    enabled: true  # Set to false to use original generation format
    # Options are always 0-indexed (0-9 max) to ensure single-token answers

# Baseline Bias Measurement
baseline:
  num_pilot_prompts: 10  # Number of prompts for Phase 0
  bias_threshold: 0.1  # Minimum bias score to proceed (10%)

# Experiment Tracking
experiment:
  name: "korean-bias-pilot"
  stage: "medium"  # pilot, medium, or full
  output_dir: "results/"
  seed: 42
  log_level: "INFO"  # DEBUG, INFO, WARNING, ERROR

# Verification Configuration
verification:
  num_random_controls: 3  # Number of random feature control experiments
  significance_level: 0.05  # p-value threshold for statistical tests
  num_repeats: 3  # Number of times to repeat each experiment for stability

# Paths (relative to project root)
paths:
  data_dir: "data/"
  results_dir: "results/"
  checkpoints_dir: "checkpoints/"
